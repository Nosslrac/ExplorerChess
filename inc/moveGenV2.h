#pragma once

#include "bitboardUtilV2.h"
#include "types.h"

#ifdef PEXT
#include "attackPextV2.h"
#else
#include "attacks.h"
#endif

#include <string>

// clang-format off
///
/// @brief The structure of the move is as follows:
/// bits 0-5: From square
/// bits 6-11: To square
/// bits 12-13: Promotion piece type if promotion, otherwise pawn double jump = 2
/// bits 14-15: Special flags (quiet = 0, castling = 1, en passant = 2, promotion = 3)
class Move final
{
public:
  constexpr explicit Move(move_t m) : move(m) {}
  [[nodiscard]] constexpr square_t getTo() const { return move & 0x3FU; }
  [[nodiscard]] constexpr square_t getFrom() const { return (move >> 6U) & 0x3FU; }
  [[nodiscard]] constexpr bool isDoubleJump() const { return (move >> 12U) == 2; }
  [[nodiscard]] constexpr bool isPromo() const { return (move >> 14U) == 3; }
  [[nodiscard]] constexpr FlagsV2 getFlags() const { return static_cast<FlagsV2>(move & 0xC000U); }
  [[nodiscard]] constexpr square_t getPromo() const { return (move >> 12U) & 0x3U; }


  static constexpr Move make(square_t from, square_t to) {
    return Move(move_t(from | (to << 6U)));
  }

  template<FlagsV2 flags>
  static constexpr Move make(square_t from, square_t to, PieceType pt = KNIGHT) {
    return Move(move_t(from | (to << 6U) | (pt - KNIGHT) << 12U | flags));
  }

private:
  move_t move;
};
// clang-format on

enum class MoveFilter : std::uint8_t
{
  QUIETS,
  CAPTURES,
  CHECK_EVASIONS
};

class Position;

namespace MoveGen {
/// @brief Generate the possible moves
template <MoveFilter filter>
index_t generate(const Position &pos, Move *moveList);
template <MoveFilter filter, Side s>
index_t generate(const Position &pos, Move *moveList);

/// @brief Gives the attack bitboard for a piece given
/// the occupancy and start square
template <PieceType p>
bitboard_t attacks(bitboard_t occupancy, square_t square);
template <Side s, PieceType p>
bitboard_t attacks(bitboard_t occupancy, square_t square);

template <MoveFilter filter, Side... s> struct MoveList final
{
  explicit MoveList(const Position &pos)
      : last(generate<filter, s...>(pos, moves)) {};
  constexpr void add(move_t move) { moves[last++] = Move(move); }
  constexpr index_t size() const { return last; }

private:
  Move moves[100];
  index_t last;
};

} // namespace MoveGen

namespace PseudoAttacks {
constexpr bitboard_t KnightAttacks[SQ_COUNT] = {
    0x0000000000020400UL, 0x0000000000050800UL, 0x00000000000a1100UL,
    0x0000000000142200UL, 0x0000000000284400UL, 0x0000000000508800UL,
    0x0000000000a01000UL, 0x0000000000402000UL, 0x0000000002040004UL,
    0x0000000005080008UL, 0x000000000a110011UL, 0x0000000014220022UL,
    0x0000000028440044UL, 0x0000000050880088UL, 0x00000000a0100010UL,
    0x0000000040200020UL, 0x0000000204000402UL, 0x0000000508000805UL,
    0x0000000a1100110aUL, 0x0000001422002214UL, 0x0000002844004428UL,
    0x0000005088008850UL, 0x000000a0100010a0UL, 0x0000004020002040UL,
    0x0000020400040200UL, 0x0000050800080500UL, 0x00000a1100110a00UL,
    0x0000142200221400UL, 0x0000284400442800UL, 0x0000508800885000UL,
    0x0000a0100010a000UL, 0x0000402000204000UL, 0x0002040004020000UL,
    0x0005080008050000UL, 0x000a1100110a0000UL, 0x0014220022140000UL,
    0x0028440044280000UL, 0x0050880088500000UL, 0x00a0100010a00000UL,
    0x0040200020400000UL, 0x0204000402000000UL, 0x0508000805000000UL,
    0x0a1100110a000000UL, 0x1422002214000000UL, 0x2844004428000000UL,
    0x5088008850000000UL, 0xa0100010a0000000UL, 0x4020002040000000UL,
    0x0400040200000000UL, 0x0800080500000000UL, 0x1100110a00000000UL,
    0x2200221400000000UL, 0x4400442800000000UL, 0x8800885000000000UL,
    0x100010a000000000UL, 0x2000204000000000UL, 0x0004020000000000UL,
    0x0008050000000000UL, 0x00110a0000000000UL, 0x0022140000000000UL,
    0x0044280000000000UL, 0x0088500000000000UL, 0x0010a00000000000UL,
    0x0020400000000000UL};

constexpr bitboard_t KingAttacks[SQ_COUNT] = {
    0x0000000000000302UL, 0x0000000000000705UL, 0x0000000000000e0aUL,
    0x0000000000001c14UL, 0x0000000000003828UL, 0x0000000000007050UL,
    0x000000000000e0a0UL, 0x000000000000c040UL, 0x0000000000030203UL,
    0x0000000000070507UL, 0x00000000000e0a0eUL, 0x00000000001c141cUL,
    0x0000000000382838UL, 0x0000000000705070UL, 0x0000000000e0a0e0UL,
    0x0000000000c040c0UL, 0x0000000003020300UL, 0x0000000007050700UL,
    0x000000000e0a0e00UL, 0x000000001c141c00UL, 0x0000000038283800UL,
    0x0000000070507000UL, 0x00000000e0a0e000UL, 0x00000000c040c000UL,
    0x0000000302030000UL, 0x0000000705070000UL, 0x0000000e0a0e0000UL,
    0x0000001c141c0000UL, 0x0000003828380000UL, 0x0000007050700000UL,
    0x000000e0a0e00000UL, 0x000000c040c00000UL, 0x0000030203000000UL,
    0x0000070507000000UL, 0x00000e0a0e000000UL, 0x00001c141c000000UL,
    0x0000382838000000UL, 0x0000705070000000UL, 0x0000e0a0e0000000UL,
    0x0000c040c0000000UL, 0x0003020300000000UL, 0x0007050700000000UL,
    0x000e0a0e00000000UL, 0x001c141c00000000UL, 0x0038283800000000UL,
    0x0070507000000000UL, 0x00e0a0e000000000UL, 0x00c040c000000000UL,
    0x0302030000000000UL, 0x0705070000000000UL, 0x0e0a0e0000000000UL,
    0x1c141c0000000000UL, 0x3828380000000000UL, 0x7050700000000000UL,
    0xe0a0e00000000000UL, 0xc040c00000000000UL, 0x0203000000000000UL,
    0x0507000000000000UL, 0x0a0e000000000000UL, 0x141c000000000000UL,
    0x2838000000000000UL, 0x5070000000000000UL, 0xa0e0000000000000UL,
    0x40c0000000000000UL};

constexpr bitboard_t PawnAttacks[2][SQ_COUNT] = {
    {0x0000000000000000UL, 0x0000000000000000UL, 0x0000000000000000UL,
     0x0000000000000000UL, 0x0000000000000000UL, 0x0000000000000000UL,
     0x0000000000000000UL, 0x0000000000000000UL, 0x0000000000000002UL,
     0x0000000000000005UL, 0x000000000000000aUL, 0x0000000000000014UL,
     0x0000000000000028UL, 0x0000000000000050UL, 0x00000000000000a0UL,
     0x0000000000000040UL, 0x0000000000000200UL, 0x0000000000000500UL,
     0x0000000000000a00UL, 0x0000000000001400UL, 0x0000000000002800UL,
     0x0000000000005000UL, 0x000000000000a000UL, 0x0000000000004000UL,
     0x0000000000020000UL, 0x0000000000050000UL, 0x00000000000a0000UL,
     0x0000000000140000UL, 0x0000000000280000UL, 0x0000000000500000UL,
     0x0000000000a00000UL, 0x0000000000400000UL, 0x0000000002000000UL,
     0x0000000005000000UL, 0x000000000a000000UL, 0x0000000014000000UL,
     0x0000000028000000UL, 0x0000000050000000UL, 0x00000000a0000000UL,
     0x0000000040000000UL, 0x0000000200000000UL, 0x0000000500000000UL,
     0x0000000a00000000UL, 0x0000001400000000UL, 0x0000002800000000UL,
     0x0000005000000000UL, 0x000000a000000000UL, 0x0000004000000000UL,
     0x0000020000000000UL, 0x0000050000000000UL, 0x00000a0000000000UL,
     0x0000140000000000UL, 0x0000280000000000UL, 0x0000500000000000UL,
     0x0000a00000000000UL, 0x0000400000000000UL, 0x0002000000000000UL,
     0x0005000000000000UL, 0x000a000000000000UL, 0x0014000000000000UL,
     0x0028000000000000UL, 0x0050000000000000UL, 0x00a0000000000000UL,
     0x0040000000000000UL},
    {0x0000000000000200UL, 0x0000000000000500UL, 0x0000000000000a00UL,
     0x0000000000001400UL, 0x0000000000002800UL, 0x0000000000005000UL,
     0x000000000000a000UL, 0x0000000000004000UL, 0x0000000000020000UL,
     0x0000000000050000UL, 0x00000000000a0000UL, 0x0000000000140000UL,
     0x0000000000280000UL, 0x0000000000500000UL, 0x0000000000a00000UL,
     0x0000000000400000UL, 0x0000000002000000UL, 0x0000000005000000UL,
     0x000000000a000000UL, 0x0000000014000000UL, 0x0000000028000000UL,
     0x0000000050000000UL, 0x00000000a0000000UL, 0x0000000040000000UL,
     0x0000000200000000UL, 0x0000000500000000UL, 0x0000000a00000000UL,
     0x0000001400000000UL, 0x0000002800000000UL, 0x0000005000000000UL,
     0x000000a000000000UL, 0x0000004000000000UL, 0x0000020000000000UL,
     0x0000050000000000UL, 0x00000a0000000000UL, 0x0000140000000000UL,
     0x0000280000000000UL, 0x0000500000000000UL, 0x0000a00000000000UL,
     0x0000400000000000UL, 0x0002000000000000UL, 0x0005000000000000UL,
     0x000a000000000000UL, 0x0014000000000000UL, 0x0028000000000000UL,
     0x0050000000000000UL, 0x00a0000000000000UL, 0x0040000000000000UL,
     0x0200000000000000UL, 0x0500000000000000UL, 0x0a00000000000000UL,
     0x1400000000000000UL, 0x2800000000000000UL, 0x5000000000000000UL,
     0xa000000000000000UL, 0x4000000000000000UL, 0x0000000000000000UL,
     0x0000000000000000UL, 0x0000000000000000UL, 0x0000000000000000UL,
     0x0000000000000000UL, 0x0000000000000000UL, 0x0000000000000000UL,
     0x0000000000000000UL}};

void print_bit_board(bitboard_t b);
} // namespace PseudoAttacks

namespace TempGUI {

inline constexpr square_t makeSquare(const std::array<char, 2> &move)
{
  assert(move.size() == 2);

  return square_t(move.at(0) - 'a' + (('8' - move.at(1)) << 3U));
}

inline std::string getCastleRights(std::uint8_t castleRights,
                                   std::string_view castleLetters)
{
  std::string castle;
  for (std::size_t i = 0; i < 4; i++)
  {
    if (castleRights & BB(i))
    {
      castle += castleLetters[i];
    }
  }
  return castle;
}

inline std::string makeSquareNotation(square_t square)
{
  if (!BitboardUtil::isOnBoard(square) || square == SQ_NONE)
  {
    return "-";
  }
  return std::string({static_cast<char>('a' + (square & 7U)),
                      static_cast<char>('8' - (square >> 3U))});
}

inline std::string makeMoveNotation(Move move)
{
  square_t from = move.getFrom();
  square_t to = move.getTo();
  if (!BitboardUtil::isOnBoard(from) || !BitboardUtil::isOnBoard(to))
  {
    return "(invalid move)";
  }
  return makeSquareNotation(from) + makeSquareNotation(to) +
         " nbrq"[move.getPromo()];
}

} // namespace TempGUI
